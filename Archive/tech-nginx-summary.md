---
title: nginx的反向代理与负载均衡总结
comments: true
date: 2016-12-15 22:23:55
categories:
- 编程
tags:
- 反向代理
---

Nginx (engine x) 是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP服务器。nginx有两个非常重要的功能就是反向代理和负载均衡，今天就这两个重要的功能做个简单总结。

<!--more-->

## 反向代理

### 原理

![2016121747446nginx.png](http://image.leeyom.top/2016121747446nginx.png)

从图中可以看出，当用户发送一个请求后，`nginx`会把请求随机转发给不同的服务器，`nginx`在当中担任一个**请求转发**的功能。

### 哪些场景要用反向代理

当用户访问的数据量比较大的时候，一台服务器无法承受如此大的数据量的时候，需要多台服务器去处理，而nginx就负责把这些请求转发给不同的服务器。

### 模拟反向代理实例

在这里我在centOS虚拟机上部署两个tomact来模拟两台服务器，这两台服务器部署了同一套代码。然后我在本机用`switchHost`来修改hosts，用浏览器访问`tomact.taotao.com`来模拟用户请求，然后观察相对应的处理结果。

#### 步骤:

1. 在虚拟机安装jdk。
2. 在虚拟机安装tomact，修改第一个tomact，主界面欢迎界面加入 **8080** 关键字， 修改第二个tomact，主界面欢迎界面加入 **8081** 关键字，来区别我们访问是不同的服务器（tomact)，然后我们启动两个tomact。
3. 配置`nginx.conf`配置文件，添加server节点，配置请求转发。然后启动`nginx`。如下

 ```
 upstream tomcats{  
    	server 10.211.55.6:8080;  
    	server 10.211.55.6:8081;  
    }  
 server {  
 		listen       80;  
 		server_name  tomact.taotao.com;  
 		#charset koi8-r;  
 		#access_log  logs/host.access.log  main;  
        location / {  
            proxy_pass   http://tomcats;  
            index  index.html index.htm;  
            }  
           }  
 ```     

#### 结果：

 1. 第一次请求，界面结果，显示`8080`界面，说明`nginx`将请求转发给了`tomact-1`。

 ![2016121798219QQ20161217-171057@2x.png](http://image.leeyom.top/2016121798219QQ20161217-171057@2x.png)

 2. 第二次请求，界面结果，显示`8081`，说明`nginx`将请求转发给了`tomact-2`。

 ![2016121758263QQ20161217-171319@2x.png](http://image.leeyom.top/2016121758263QQ20161217-171319@2x.png)

## 负载均衡

### 原理

![201612174195QQ20161217-172130@2x.png](http://image.leeyom.top/201612174195QQ20161217-172130@2x.png)

从图中可以看出，用户发起请求后，`nginx`检测到，服务器1出现宕机，立马将请求转移给服务器4，将压力转移到服务器4上面，从而实现负载均衡。

### 哪些场景要用到负载均衡

如果我们的服务器的配置各有不同，那么我们就可以通过`nginx`为每台服务器设置权重，配置好的服务器可以承受更多请求，配置差一点的承担的压力要少一点，从而实现负载均衡。

### 模拟负载均衡实例

在之前配置的基础上，再次配置`nginx.conf`配置文件，为每台服务器添加权重`weight`，`weight`的值默认为1，`weight`的值越大，`nginx`将请求转发到该服务器的概率也就越大，然后启动`nginx`。如下：

![2016121714181QQ20161217-180240@2x.png](http://image.leeyom.top/2016121714181QQ20161217-180240@2x.png)        


发起请求，发现界面显示的是`8080`，再次发起请求，界面依旧显示的是`8080`，第三次刷新的时候，界面才显示`8081`，由此可见，权重越大，nginx将请求转发给该服务器的概率越大，这就是负载均衡。
